# Veramo Verifier

The Veramo-Verifier is a Veramo based agent that assists in handling the OpenID4VCP presentation protocol flow.

## Environment variables

Secrets and connection parameters can be configured using the `.env` specification:

```text
DB_NAME=<postgres database name, default postgres>
DB_SCHEMA=<postgres database schema name, default verifier>
DB_USER=<postgres database user name, default postgres>
DB_PASSWORD=<postgres database password, default postgres>
DB_HOST=<postgres database host, default localhost>
DB_PORT=<postgres database port, default 5432>

PORT=<port number for the verifier agent to listen to, default 5000>
LISTEN_ADDRESS=<network interface address to bind to, default 0.0.0.0>
BASEURL=<base Url for the verifier agent, default https://verifier.dev.eduwallet.nl>
```

## Installation

Run `yarn` to install the basic packages:

`yarn install`

## Configuration

Configuration falls into three rough categories:

- dids
- verifiable presentations
- instances

The dids are configured in the `conf/dids` path and describe how to create the key if it does not yet exist in the database. Each key has an alias that can be referenced in the `instance` specification.

The verifiable presentations are JSON documents describing the request for a specific credential, according to the https://identity.foundation/presentation-exchange/spec/v2.0.0/ specification on Presentation Exchange. Each such presentation is defined by the `id` attribute in the document.

The `instances` are a set of endpoints that are callable by front-end-verifiers and wallets. For each `instance` the configuration specifies the `subpath`, the administrator bearer `token`, the `did` used for this `instance` and the Verifiable Presentations that are allowed (by id).

## Interfaces

The front-end-facing verifiers can interact with the Veramo-Verifier using their specific administrative `token`. There are two basic endpoints for this api: request a new authorization request object, and poll for status updates on a previously created authorization request.

To support the Credential Verification process, the Veramo-Verifier has some additional endpoints:

- get-credential-offer: the endpoint to get the actual Authorization Request Object
- get-presentation-def: the endpoint to get a specific presentation definition
- receive-response: the endpoint to which the wallet sends its verification response

## Endpoint definitions

### Create Offer

`/:instance/api/create-offer/:presentationid`

This endpoint creates a new state object for a specific presentation. The presentation must be in the set of allowed presentations for this `instance`, for example, `ABC` or `PID`. This endpoint has a `POST` method, although no actual data is posted at the moment. It has content-type `json` and requires the `Authorization: Bearer <token>` header.

The Veramo-Verifier replies with a response object containing the following data:

```json
{
    "state": "<random state generated by the Veramo-Verifier>",
    "requestUri": "<uri, containing state, to be presented as QR code or link>",
    "checkUri": "<uri to be polled by the front-end-verifier for status updates>"
}
```

### Check Offer

`/:instance/api/check-offer/:state`

This endpoint allows the front-end verifier to poll for status updates with the Veramo-Verifier while the wallet interacts with the agent. It returns the following object:

```json
{
  "status": "AuthorizationRequestCreated",
  "created": "2024-09-13T09:20:49+00:00",
  "lastUpdate": "2024-09-13T09:20:49+00:00"
}
```

The status attribute can be one of the following:

- AuthorizationRequestCreated: object was created, waiting for interaction
- AuthorizationRequestRetrieved: wallet has scanned the code, user interaction required
- ResponseReceived: Verifiable Presentation was returned, data available

When the last status is returned, the response object is extended with the following attributes:

```json
{
  "status": "ResponseReceived",
  "created": "2024-09-13T09:20:49+00:00",
  "lastUpdate": "2024-09-13T09:20:49+00:00",
  "state": "cb3349e1-8415-4d96-bd40-d03663836ad5",
  "nonce": "8472d4aa-0429-4084-8596-b6adebf7248c",
  "issuer": "<did key of the VP signer (should be the wallet)>",
  "credentials": [{
    "holder": "<did key of the VC holder (wallet)>",
    "issuerKey": "<did key of the VC issuer>",
    "issuer": "<VC issuer id, which currently equals the issuerKey>",
    "claims": {
      [x:string]: string|number
    }
  }]
}
```

As mentioned above, only one credential is supported at this time, so the `credentials` attribute list only ever contains a single entry.

The `claims` attribute contains the actual claims as present in the Verifiable Credential and need to be interpreted by the front-end-verifier. No data types, etc. are available, except in the relevant issuer metadata. It is assumed the front-end-verifier knows in advance the mark-up required for presenting this specific type of Verifiable Credential.

### Get Credential Offer

The link sent to be presented to the wallet points to this endpoint. The wallet can retrieve the proper `Authorization Object` which kicks off the Credential Verification process.

`/:instance/get-offer/:state`

The interface contains a `state` variable to link this interaction with the previously requested offer from the front-end-verifier, allowing the front-end-verifier to retrieve the credential data in the end.

The response object looks similar to the following (JWT payload)

```json
{
  "iat": 1725272520,
  "exp": 1725272640,
  "response_type": "vp_token",
  "scope": "openid",
  "client_id": "<did key of the verifier agent for this instance>",
  "response_uri": "<uri to send the wallet response to (see below)>",
  "response_mode": "direct_post",
  "nonce": "8472d4aa-0429-4084-8596-b6adebf7248c",
  "state": "cb3349e1-8415-4d96-bd40-d03663836ad5",
  "presentation_definition_uri": "<uri on the Veramo Agent to get the presentation request>",
Â  "client_metadata": { ... }
  },
  "nbf": 1725272520,
  "jti": "9f498f77-a3f3-4991-88aa-917c9fd7c06c",
  "iss": "<did key of the verifier agent for this instance>",
  "sub": "<did key of the verifier agent for this instance>"
}
```

This is actually a self-signed JWT indicating the Veramo Verifier is in control of this key (`iss`, `sub`) and requests the wallet to send the credential(s) as indicated by the presentation to the response_uri.

### Get Presentation Def

`/:instance/get-presentation/:presentation`

This endpoint is stateless and requests the presentation definition as defined by the parameter. Without selective disclosure, any request for a claim in a Verifiable Credential will always yield the entire credential, so the presentation is usually a simple setup that requests a simple, omnipresent field. It looks as follows:

```json
{
  id: 'ABC',
  name: 'Academic Base Credential',
  purpose: 'Identify using your Academic Base Credential',
  input_descriptors: [{
      id: 'ABC',
      name: 'Academic Base Credential',
      purpose: 'Identify using your Academic Base Credential',
      schema: [{
        "uri": "AcademicBaseCredential"
      }],
      "constraints": {
        "fields": [{
          "path": ["$.credentialSubject.given_name"]
        }]
      }
  }]
}
```

In this example, the purpose of the entire presentation is the same as the purpose for requesting the one credential. The `given_name` is requested, which is always present, so the wallet can select all AcademicBaseCredential credentials it has available and allow the user to pick one.

### Receive Response

`/:instance/response/:state`

The wallet sends the final response to this endpoint, which switches the interaction state to `ResponseReceived` and will provide the credential data to the front-end-verifier.

The response object is a html form encoded set of key-values:

```
expires_in: '300'
state: '6c9c611d-ee10-4c9d-9af5-5992ad191019'
presentation_submission: '{
  "id":"grAU7C0oHg2oinn1IAcw6",
  "definition_id":"ABC",
  "descriptor_map":[{
    "id":"ABC",
    "format":"jwt_vp",
    "path":"$",
    "path_nested":{
      "id":"ABC",
      "format":"jwt_vc",
      "path":"$.vp.verifiableCredential[0]"
    }
  }]
}'
vp_token: <JWT>
```

The `presentation_submission` indicates where to find the requested fields in the set of Verifiable Credentials transmitted. It is a response to the `constraints` field in the presentation definition above.

The actual Verifiable Credentials are stored in the `vp_token` attribute. The Veramo-Verifier decodes and verifies the JWT and collects all the claims for the front-end-verifier.

